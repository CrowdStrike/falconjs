#!/bin/sh

set -e -o pipefail -x

VERSION=0.2.5 # Target version of FalconJS

# TODO: obtain swagger
# TODO: obtain transformation.jq from gofalcon repo
# jq -f ./specs/transformation.jq $ORIGINAL_SWAGGER > ${PATCHED_SWAGGER_FILE}

PATCHED_SWAGGER_FILE=./specs/swagger-patched.json # Obtain swagger file and then patch it with gofalcon pipeline

mkdir -p specs
# cp ../gofalcon/specs/swagger-patched.json ./specs/

jq '.info.version="rolling"' ${PATCHED_SWAGGER_FILE} > ./specs/final.json

typ=typescript-fetch
build_dir="specs/out/$typ"
rm -rf "./$build_dir"

if [ -z "$1" ]; then
   BUILD_CONTAINER="openapitools/openapi-generator-cli"
   docker pull "$BUILD_CONTAINER"
else
   BUILD_CONTAINER="$1"
fi

docker run --rm \
       -v "$PWD":/falcon-js "$BUILD_CONTAINER" generate \
       -i /falcon-js/specs/final.json \
       -g "${typ}" \
       -o "/falcon-js/$build_dir" \
       --additional-properties=httpUserAgent=falconjs/$VERSION \
       --additional-properties=packageName=falconjs \
       --additional-properties=packageVersion=$VERSION \
       --additional-properties=npmVersion=$VERSION \
       --additional-properties=disallowAdditionalPropertiesIfNotPresent=false \
       --additional-properties=useSingleRequestParameter=false \
       --additional-properties=npmName=crowdstrike-falcon \
       --additional-properties=npmRepository=https://github.com/crowdstrike/falcon-js \
       --additional-properties=supportsES6=true \
       --additional-properties=typescriptThreePlus=true \
       --skip-validate-spec

grep -lr ./src -e 'This class is auto generated by OpenAPI Generator' | xargs rm --

cp -a ./${build_dir}/src/* ./src/

npm run format:fix

PATCH=5ad9def830f472a2e4e1e3e33007b677b42f2b1
git format-patch ${PATCH}^..${PATCH}
git apply 0001-Quick-dirty-plug-of-build-failures.patch
rm 0001-Quick-dirty-plug-of-build-failures.patch

git checkout -p src/index.ts

git diff

git add -p
git add src/
git commit -m "Re-generate the codebase using the latest swagger"

npm run build
