#!/bin/sh

set -e -o pipefail -x

VERSION="0.3.0" # Target version of FalconJS
PATCHED_SWAGGER_FILE=./specs/swagger-patched.json
ORIGINAL_SWAGGER=./specs/swagger.json

mkdir -p specs

# obtain swagger https://assets.falcon.crowdstrike.com/support/api/swagger.json
[ ! -f "$ORIGINAL_SWAGGER" ] && echo "File $ORIGINAL_SWAGGER not found. Please manually download it." && exit 1

curl -o ./specs/transformation.jq https://raw.githubusercontent.com/crowdstrike/gofalcon/main/specs/transformation.jq
jq -f ./specs/transformation.jq ${ORIGINAL_SWAGGER} | jq -f ./specs/transformation_local.jq > ${PATCHED_SWAGGER_FILE}
jq '.info.version="rolling"' ${PATCHED_SWAGGER_FILE} > ./specs/final.json

typ=typescript-fetch
build_dir="specs/out/$typ"
rm -rf "./$build_dir"

if [ -z "$1" ]; then
   BUILD_CONTAINER="openapitools/openapi-generator-cli"
   docker pull "$BUILD_CONTAINER"
else
   BUILD_CONTAINER="$1"
fi

docker run --rm \
       -v "$PWD":/falcon-js "$BUILD_CONTAINER" generate \
       -i /falcon-js/specs/final.json \
       -g "${typ}" \
       -o "/falcon-js/$build_dir" \
       --additional-properties=httpUserAgent=falconjs/$VERSION \
       --additional-properties=packageName=falconjs \
       --additional-properties=packageVersion=$VERSION \
       --additional-properties=npmVersion=$VERSION \
       --additional-properties=disallowAdditionalPropertiesIfNotPresent=false \
       --additional-properties=useSingleRequestParameter=false \
       --additional-properties=npmName=crowdstrike-falcon \
       --additional-properties=npmRepository=https://github.com/crowdstrike/falcon-js \
       --additional-properties=supportsES6=true \
       --additional-properties=typescriptThreePlus=true \
       --skip-validate-spec

grep -lr ./src -e 'This class is auto generated by OpenAPI Generator' | xargs rm --

cp -a ./${build_dir}/src/* ./src/

npm run format:fix

PATCH=7fc61ee76869bb3bd8f3173348c26949f35c2cbd
git format-patch ${PATCH}^..${PATCH}
git apply 0001-fix-Resolve-build-errors-from-codegen.patch
rm 0001-fix-Resolve-build-errors-from-codegen.patch

# git checkout -p src/index.ts
# git diff
# git add -p
git add src/
git commit -m "Re-generate the codebase using the latest swagger"

npm run build
